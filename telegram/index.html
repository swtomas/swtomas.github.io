<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked (Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* --- Native Telegram Theme Adaptation --- */
        :root {
            --tg-theme-bg-color: #17212b;
            --tg-theme-text-color: #f5f5f5;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #64b5ef;
            --tg-theme-button-color: #5288c1;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #232e3c;
            --tg-theme-header-bg-color: #17212b;
            --tg-viewport-height: 100vh;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Markdown Styles (Explicit Fixes) --- */
        .markdown-content {
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 700;
            margin-top: 12px;
            margin-bottom: 8px;
            line-height: 1.2;
        }
        .markdown-content h1 { font-size: 1.4em; }
        .markdown-content h2 { font-size: 1.2em; }
        .markdown-content p { margin-bottom: 8px; }
        .markdown-content ul, .markdown-content ol {
            padding-left: 20px;
            margin-bottom: 8px;
        }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 4px; }
        .markdown-content strong { font-weight: 700; color: inherit; }
        .markdown-content em { font-style: italic; }
        .markdown-content code {
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #ff7070;
        }
        .markdown-content pre {
            background: #0f1115;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: #a9b7c6;
            font-size: 0.85em;
        }
        .markdown-content blockquote {
            border-left: 3px solid var(--tg-theme-link-color);
            padding-left: 10px;
            margin: 8px 0;
            opacity: 0.8;
            font-style: italic;
        }
        .markdown-content a { color: var(--tg-theme-link-color); text-decoration: none; }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* --- Animations --- */
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .msg-anim { animation: messageIn 0.2s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        .typing-dot {
            display: inline-block; width: 5px; height: 5px; margin-right: 3px;
            background-color: var(--tg-theme-hint-color); border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const POLLINATIONS_API_KEY = "plln_pk_v7Ic6CjSJs34yFa9aKlCDEUjdsLb9HMb"; 
        
        // –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –º–æ–¥–µ–ª–µ–π
        const MODEL_DISPLAY_NAMES = {
            'openai': 'GPT 5 Nano',
            'claude': 'Claude 4.5 Haiku',
            'gemini-search': 'Gemini 2.5 Flash Lite'
        };

        const SYSTEM_PROMPT = `–¢—ã —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ Telegram.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª–µ–∑–Ω–æ, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –ò—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç, —Å–ø–∏—Å–∫–∏, –∫–æ–¥).
–í–ê–ñ–ù–û –ü–†–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ —Ñ–æ—Ç–æ:
1. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –¢–û–õ–¨–ö–û –∏–∑ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: "IMAGE_GENERATE_CMD: <–æ–ø–∏—Å–∞–Ω–∏–µ>"
2. –í <–æ–ø–∏—Å–∞–Ω–∏–µ> –≤—Å—Ç–∞–≤—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ú–æ–∂–µ—à—å –Ω–µ–º–Ω–æ–≥–æ —É–ª—É—á—à–∏—Ç—å –µ–≥–æ, –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏, –Ω–æ –ù–ï –ü–ï–†–ï–í–û–î–ò –µ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–µ–π—Ä–æ—Å–µ—Ç—å –ø–æ–π–º–µ—Ç.
–ü—Ä–∏–º–µ—Ä: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ö–æ—Ç –≤ –∫–æ—Å–º–æ—Å–µ" -> –û—Ç–≤–µ—Ç: "IMAGE_GENERATE_CMD: –ö–æ—Ç –≤ –∫–æ—Å–º–æ—Å–µ, –≤—ã—Å–æ–∫–æ–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ, 8k"`;

        // ==========================================
        // ICONS (SVG)
        // ==========================================
        const Icons = {
            Send: ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
            Settings: ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            History: ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Chat: ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            BotIcon: ({size=24, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>,
            Trash: ({size=18, className}) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            ChevronUp: ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
        };

        const { useState, useEffect, useRef } = React;

        // --- Markdown Component ---
        const MarkdownMessage = ({ content }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º marked –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
                    containerRef.current.innerHTML = marked.parse(content);
                }
            }, [content]);

            return <div className="markdown-content" ref={containerRef} />;
        };

        // --- Model Selector (Bottom Left) ---
        const ModelSelector = ({ models, selectedModel, onSelect, isOpen, setIsOpen }) => {
            const getDisplayName = (id) => MODEL_DISPLAY_NAMES[id] || id.charAt(0).toUpperCase() + id.slice(1);
            
            return (
                <div className="relative">
                    {isOpen && (
                        <div className="absolute bottom-12 left-0 w-48 max-h-60 overflow-y-auto bg-[var(--tg-theme-secondary-bg-color)] border border-[var(--tg-theme-hint-color)] rounded-xl shadow-xl z-50 p-1 mb-2">
                            <div className="text-[10px] text-[var(--tg-theme-hint-color)] uppercase px-2 py-1 font-bold">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</div>
                            {models.map(m => (
                                <button
                                    key={m.name}
                                    onClick={() => {
                                        onSelect(m.name);
                                        setIsOpen(false);
                                        if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
                                    }}
                                    className={`w-full text-left px-3 py-2 text-xs rounded-lg mb-1 truncate transition-colors ${selectedModel === m.name ? 'bg-[var(--tg-theme-button-color)] text-white' : 'text-[var(--tg-theme-text-color)] hover:bg-[var(--tg-theme-bg-color)]'}`}
                                >
                                    {getDisplayName(m.name)}
                                </button>
                            ))}
                        </div>
                    )}
                    <button 
                        onClick={() => {
                            setIsOpen(!isOpen);
                            if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        }}
                        className="h-10 px-3 bg-[var(--tg-theme-secondary-bg-color)] rounded-l-2xl border-r border-[var(--tg-theme-bg-color)] flex items-center justify-center text-[var(--tg-theme-hint-color)] hover:text-[var(--tg-theme-text-color)] transition-colors"
                    >
                        <div className="flex items-center gap-1">
                            <Icons.BotIcon size={20} />
                            <span className="text-[10px] font-bold max-w-[60px] truncate">{getDisplayName(selectedModel)}</span>
                        </div>
                    </button>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('chat');
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [models, setModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('openai');
            const [isModelMenuOpen, setIsModelMenuOpen] = useState(false);
            
            // History
            const [history, setHistory] = useState([]);
            const [currentChatId, setCurrentChatId] = useState(Date.now());

            const messagesEndRef = useRef(null);

            // --- Initialization ---
            useEffect(() => {
                // Telegram Init
                if (window.Telegram?.WebApp) {
                    const tg = window.Telegram.WebApp;
                    tg.ready();
                    tg.expand();
                    // Apply native theme colors from Telegram to CSS variables fallback
                    document.documentElement.style.setProperty('--tg-theme-bg-color', tg.backgroundColor || '#17212b');
                    document.documentElement.style.setProperty('--tg-theme-text-color', tg.textColor || '#f5f5f5');
                    document.documentElement.style.setProperty('--tg-theme-button-color', tg.buttonColor || '#5288c1');
                    document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.buttonTextColor || '#ffffff');
                    document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.secondaryBackgroundColor || '#232e3c');
                }

                // Load History
                try {
                    const saved = localStorage.getItem('chat_history');
                    if (saved) {
                        setHistory(JSON.parse(saved));
                    }
                } catch(e){}

                // Fetch Models
                fetch('https://enter.pollinations.ai/api/generate/text/models')
                    .then(r => r.json())
                    .then(data => {
                        setModels(data);
                        if(data.find(m => m.name === 'openai')) setSelectedModel('openai');
                    })
                    .catch(() => setModels([{name: 'openai'}, {name: 'mistral'}, {name: 'claude'}]));

            }, []);

            // Auto-scroll
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // Save History Logic
            useEffect(() => {
                if(messages.length > 0) {
                    const updatedHistory = [...history];
                    const index = updatedHistory.findIndex(c => c.id === currentChatId);
                    
                    const chatItem = {
                        id: currentChatId,
                        title: messages[0].content.slice(0, 30) || '–ù–æ–≤—ã–π —á–∞—Ç',
                        date: Date.now(),
                        messages: messages,
                        model: selectedModel
                    };

                    if(index > -1) updatedHistory[index] = chatItem;
                    else updatedHistory.unshift(chatItem);

                    setHistory(updatedHistory);
                    localStorage.setItem('chat_history', JSON.stringify(updatedHistory));
                }
            }, [messages, currentChatId]);

            const handleSend = async () => {
                if (!input.trim() || isLoading) return;
                
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');

                const userText = input;
                setInput('');
                setIsModelMenuOpen(false); // Close menu if open
                const newMessages = [...messages, { role: 'user', content: userText }];
                setMessages(newMessages);
                setIsLoading(true);

                try {
                    const response = await fetch('https://enter.pollinations.ai/api/generate/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: [
                                { role: 'system', content: SYSTEM_PROMPT },
                                ...newMessages
                            ],
                            stream: true
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let aiText = '';
                    
                    setMessages(prev => [...prev, { role: 'assistant', content: '' }]);

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') break;
                                try {
                                    const json = JSON.parse(data);
                                    const delta = json.choices[0].delta.content || '';
                                    aiText += delta;
                                    setMessages(prev => {
                                        const updated = [...prev];
                                        updated[updated.length - 1].content = aiText;
                                        return updated;
                                    });
                                } catch (e) {}
                            }
                        }
                    }

                    // Image Generation Check
                    if (aiText.includes('IMAGE_GENERATE_CMD:')) {
                        const prompt = aiText.replace('IMAGE_GENERATE_CMD:', '').trim();
                        const seed = Math.floor(Math.random() * 100000);
                        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?n=${seed}`;
                        
                        setMessages(prev => {
                            const updated = [...prev];
                            updated[updated.length - 1].content = `üé® **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:** ${prompt}\n\n![Image](${imageUrl})`;
                            return updated;
                        });
                    }

                } catch (e) {
                    setMessages(prev => [...prev, { role: 'assistant', content: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.' }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const loadChat = (chat) => {
                setCurrentChatId(chat.id);
                setMessages(chat.messages);
                setSelectedModel(chat.model);
                setActiveTab('chat');
            };

            const createNewChat = () => {
                setCurrentChatId(Date.now());
                setMessages([]);
                setActiveTab('chat');
                if(window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            };

            // --- RENDER ---
            return (
                <div className="flex flex-col h-[var(--tg-viewport-height)]">
                    
                    {/* VIEW: CHAT */}
                    {activeTab === 'chat' && (
                        <>
                            <div className="flex-1 overflow-y-auto px-3 py-4 custom-scrollbar">
                                {messages.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center opacity-50 pb-20">
                                        <div className="w-20 h-20 bg-[var(--tg-theme-secondary-bg-color)] rounded-full flex items-center justify-center mb-4 shadow-lg">
                                            <Icons.BotIcon size={40} className="text-[var(--tg-theme-button-color)]" />
                                        </div>
                                        <h3 className="text-lg font-bold mb-1">–ü—Ä–∏–≤–µ—Ç!</h3>
                                        <p className="text-sm text-center max-w-[250px]">–Ø –ø–æ–º–æ–≥—É —Å —Ç–µ–∫—Å—Ç–æ–º, –∫–æ–¥–æ–º –∏–ª–∏ –Ω–∞—Ä–∏—Å—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.</p>
                                    </div>
                                ) : (
                                    messages.map((m, i) => (
                                        <div key={i} className={`flex mb-3 ${m.role === 'user' ? 'justify-end' : 'justify-start'} msg-anim`}>
                                            <div 
                                                className={`max-w-[85%] px-4 py-2 rounded-2xl shadow-sm ${
                                                    m.role === 'user' 
                                                    ? 'bg-[var(--tg-theme-button-color)] text-white rounded-br-none' 
                                                    : 'bg-[var(--tg-theme-secondary-bg-color)] rounded-bl-none'
                                                }`}
                                            >
                                                <MarkdownMessage content={m.content} />
                                            </div>
                                        </div>
                                    ))
                                )}
                                {isLoading && messages[messages.length-1]?.role === 'user' && (
                                    <div className="flex justify-start mb-3">
                                        <div className="bg-[var(--tg-theme-secondary-bg-color)] px-4 py-3 rounded-2xl rounded-bl-none flex items-center">
                                            <div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} className="h-4" />
                            </div>

                            {/* INPUT BAR (Native Style) */}
                            <div className="bg-[var(--tg-theme-secondary-bg-color)] p-2 pb-safe-area border-t border-[rgba(0,0,0,0.1)] flex items-end gap-0">
                                {/* Model Selector (Bottom Left as requested) */}
                                <ModelSelector 
                                    models={models} 
                                    selectedModel={selectedModel} 
                                    onSelect={setSelectedModel} 
                                    isOpen={isModelMenuOpen}
                                    setIsOpen={setIsModelMenuOpen}
                                />
                                
                                <input
                                    type="text"
                                    value={input}
                                    onChange={e => setInput(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleSend()}
                                    placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."
                                    className="flex-1 h-10 bg-[var(--tg-theme-secondary-bg-color)] text-[var(--tg-theme-text-color)] text-sm px-3 focus:outline-none border-y border-r border-[var(--tg-theme-bg-color)] rounded-r-2xl"
                                    style={{borderLeft: 'none'}} // Connect to selector
                                />
                                
                                <button 
                                    onClick={handleSend}
                                    disabled={!input.trim() || isLoading}
                                    className={`ml-2 h-10 w-10 flex items-center justify-center rounded-full transition-all ${input.trim() ? 'bg-[var(--tg-theme-button-color)] text-white shadow-md' : 'text-[var(--tg-theme-hint-color)]'}`}
                                >
                                    <Icons.Send size={20} />
                                </button>
                            </div>
                        </>
                    )}

                    {/* VIEW: HISTORY */}
                    {activeTab === 'history' && (
                        <div className="flex-1 overflow-y-auto bg-[var(--tg-theme-bg-color)] p-4">
                            <h2 className="text-xl font-bold mb-4 px-2">–ò—Å—Ç–æ—Ä–∏—è</h2>
                            <button 
                                onClick={createNewChat} 
                                className="w-full py-3 bg-[var(--tg-theme-button-color)] text-white rounded-xl mb-6 font-medium shadow-md active:scale-95 transition-transform"
                            >
                                + –ù–æ–≤—ã–π —á–∞—Ç
                            </button>
                            <div className="space-y-2">
                                {history.map(chat => (
                                    <div 
                                        key={chat.id}
                                        onClick={() => loadChat(chat)}
                                        className="bg-[var(--tg-theme-secondary-bg-color)] p-4 rounded-xl flex justify-between items-center active:bg-opacity-80 transition-opacity"
                                    >
                                        <div className="overflow-hidden">
                                            <div className="font-semibold truncate pr-4">{chat.title}</div>
                                            <div className="text-xs text-[var(--tg-theme-hint-color)]">
                                                {new Date(chat.date).toLocaleDateString()} ‚Ä¢ {MODEL_DISPLAY_NAMES[chat.model] || chat.model}
                                            </div>
                                        </div>
                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                const newH = history.filter(h => h.id !== chat.id);
                                                setHistory(newH);
                                                localStorage.setItem('chat_history', JSON.stringify(newH));
                                            }}
                                            className="p-2 text-[var(--tg-theme-hint-color)] hover:text-red-400"
                                        >
                                            <Icons.Trash size={18} />
                                        </button>
                                    </div>
                                ))}
                                {history.length === 0 && <div className="text-center text-[var(--tg-theme-hint-color)] mt-10">–ü—É—Å—Ç–æ</div>}
                            </div>
                        </div>
                    )}

                    {/* VIEW: SETTINGS */}
                    {activeTab === 'settings' && (
                        <div className="flex-1 p-4 bg-[var(--tg-theme-bg-color)]">
                            <h2 className="text-xl font-bold mb-4 px-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <div className="bg-[var(--tg-theme-secondary-bg-color)] rounded-xl overflow-hidden">
                                <div className="p-4 border-b border-[var(--tg-theme-bg-color)] flex justify-between items-center">
                                    <span>–í–µ—Ä—Å–∏—è</span>
                                    <span className="text-[var(--tg-theme-hint-color)]">2.0 Native</span>
                                </div>
                                <div className="p-4 flex justify-between items-center">
                                    <span>API</span>
                                    <span className="text-[var(--tg-theme-hint-color)]">Pollinations AI</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* BOTTOM NAV */}
                    <div className="h-[55px] bg-[var(--tg-theme-secondary-bg-color)] border-t border-[rgba(0,0,0,0.1)] flex justify-around items-center">
                        <button onClick={() => setActiveTab('history')} className={`flex-1 flex flex-col items-center justify-center h-full ${activeTab === 'history' ? 'text-[var(--tg-theme-button-color)]' : 'text-[var(--tg-theme-hint-color)]'}`}>
                            <Icons.History size={24} />
                            <span className="text-[10px] mt-0.5">–ò—Å—Ç–æ—Ä–∏—è</span>
                        </button>
                        <button onClick={() => setActiveTab('chat')} className={`flex-1 flex flex-col items-center justify-center h-full ${activeTab === 'chat' ? 'text-[var(--tg-theme-button-color)]' : 'text-[var(--tg-theme-hint-color)]'}`}>
                            <Icons.Chat size={24} />
                            <span className="text-[10px] mt-0.5">–ß–∞—Ç</span>
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex-1 flex flex-col items-center justify-center h-full ${activeTab === 'settings' ? 'text-[var(--tg-theme-button-color)]' : 'text-[var(--tg-theme-hint-color)]'}`}>
                            <Icons.Settings size={24} />
                            <span className="text-[10px] mt-0.5">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </button>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
